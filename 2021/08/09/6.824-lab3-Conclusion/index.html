<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>6.824 Conclusion | Yitao&#39;s Blog</title>
  <meta name="description" content="Conclusion  Lab3 is a tough journey, especially when you finish the whole framework, then problem just starts. I took roughly two days to complete my draft and spent 2-3 times time to debug. In order">
<meta property="og:type" content="article">
<meta property="og:title" content="6.824 Conclusion">
<meta property="og:url" content="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/index.html">
<meta property="og:site_name" content="Yitao&#39;s Blog">
<meta property="og:description" content="Conclusion  Lab3 is a tough journey, especially when you finish the whole framework, then problem just starts. I took roughly two days to complete my draft and spent 2-3 times time to debug. In order">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/structural1.png">
<meta property="og:image" content="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/structural2.jpg">
<meta property="og:image" content="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/bug1.png">
<meta property="og:image" content="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/bug2.png">
<meta property="article:published_time" content="2021-08-09T08:53:11.992Z">
<meta property="article:modified_time" content="2021-08-09T10:06:39.243Z">
<meta property="article:author" content="Wang Yitao">
<meta property="article:tag" content="KV Raft">
<meta property="article:tag" content="Lab Note">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/structural1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Yitao&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/ZjuYTW" target="_blank">
          <img class="img-circle img-rotate" src="/images/ichigo1.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Yitao</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">To become what I want to be!</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Singapore</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/null">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/null">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Books</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/null">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/ZjuYTW" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>My personal website, writing for fun and sharding knowledge</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/6-824/">6.824</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/6-S081/">6.S081</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm-at-Scale/">Algorithm at Scale</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/">Leetcode</a><span class="category-list-count">38</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Aurora/" rel="tag">Aurora</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BFS/" rel="tag">BFS</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BST/" rel="tag">BST</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Back-Tracking/" rel="tag">Back Tracking</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bitcoin/" rel="tag">Bitcoin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/COPS/" rel="tag">COPS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CRAQ/" rel="tag">CRAQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Certificate-Transparency/" rel="tag">Certificate Transparency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DFS/" rel="tag">DFS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DP/" rel="tag">DP</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distributed-Systems/" rel="tag">Distributed Systems</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FaRM/" rel="tag">FaRM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fast-Slow-pointers/" rel="tag">Fast-Slow pointers</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Finite-State-Machine/" rel="tag">Finite State Machine</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Floyd/" rel="tag">Floyd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Frangipani/" rel="tag">Frangipani</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Greedy/" rel="tag">Greedy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap/" rel="tag">Heap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iteration/" rel="tag">Iteration</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KV-Raft/" rel="tag">KV Raft</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lab-Note/" rel="tag">Lab Note</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/" rel="tag">Math</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maximum-Increasing-Subsequence/" rel="tag">Maximum Increasing Subsequence</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memcache-FB/" rel="tag">Memcache@FB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memory-Management/" rel="tag">Memory Management</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Monotone-Stack/" rel="tag">Monotone Stack</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/No-AC-first-time/" rel="tag">No AC first time</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Priority-Queue/" rel="tag">Priority Queue</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pruning/" rel="tag">Pruning</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raft/" rel="tag">Raft</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sampling-Algorithm/" rel="tag">Sampling Algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ShardKV-Storage/" rel="tag">ShardKV Storage</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spanner/" rel="tag">Spanner</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stack/" rel="tag">Stack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/State-Compression/" rel="tag">State Compression</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/" rel="tag">String</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stringstream/" rel="tag">Stringstream</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Syscall/" rel="tag">Syscall</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tricky/" rel="tag">Tricky</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Trie-Tree/" rel="tag">Trie Tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Two-Pointers/" rel="tag">Two Pointers</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Union-Find-Set/" rel="tag">Union Find Set</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xv6/" rel="tag">xv6</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Aurora/" style="font-size: 13px;">Aurora</a> <a href="/tags/BFS/" style="font-size: 13.43px;">BFS</a> <a href="/tags/BST/" style="font-size: 13px;">BST</a> <a href="/tags/Back-Tracking/" style="font-size: 13.14px;">Back Tracking</a> <a href="/tags/Bitcoin/" style="font-size: 13px;">Bitcoin</a> <a href="/tags/COPS/" style="font-size: 13px;">COPS</a> <a href="/tags/CRAQ/" style="font-size: 13px;">CRAQ</a> <a href="/tags/Certificate-Transparency/" style="font-size: 13px;">Certificate Transparency</a> <a href="/tags/DFS/" style="font-size: 13.57px;">DFS</a> <a href="/tags/DP/" style="font-size: 13.71px;">DP</a> <a href="/tags/Distributed-Systems/" style="font-size: 13.86px;">Distributed Systems</a> <a href="/tags/FaRM/" style="font-size: 13px;">FaRM</a> <a href="/tags/Fast-Slow-pointers/" style="font-size: 13px;">Fast-Slow pointers</a> <a href="/tags/Finite-State-Machine/" style="font-size: 13.14px;">Finite State Machine</a> <a href="/tags/Floyd/" style="font-size: 13px;">Floyd</a> <a href="/tags/Frangipani/" style="font-size: 13px;">Frangipani</a> <a href="/tags/Greedy/" style="font-size: 13.29px;">Greedy</a> <a href="/tags/Heap/" style="font-size: 13px;">Heap</a> <a href="/tags/Iteration/" style="font-size: 13px;">Iteration</a> <a href="/tags/KV-Raft/" style="font-size: 13.14px;">KV Raft</a> <a href="/tags/Lab-Note/" style="font-size: 13.57px;">Lab Note</a> <a href="/tags/MapReduce/" style="font-size: 13px;">MapReduce</a> <a href="/tags/Math/" style="font-size: 13.14px;">Math</a> <a href="/tags/Maximum-Increasing-Subsequence/" style="font-size: 13px;">Maximum Increasing Subsequence</a> <a href="/tags/Memcache-FB/" style="font-size: 13px;">Memcache@FB</a> <a href="/tags/Memory-Management/" style="font-size: 13px;">Memory Management</a> <a href="/tags/Monotone-Stack/" style="font-size: 13.14px;">Monotone Stack</a> <a href="/tags/No-AC-first-time/" style="font-size: 14px;">No AC first time</a> <a href="/tags/Priority-Queue/" style="font-size: 13.14px;">Priority Queue</a> <a href="/tags/Pruning/" style="font-size: 13px;">Pruning</a> <a href="/tags/Raft/" style="font-size: 13.14px;">Raft</a> <a href="/tags/Sampling-Algorithm/" style="font-size: 13px;">Sampling Algorithm</a> <a href="/tags/ShardKV-Storage/" style="font-size: 13.14px;">ShardKV Storage</a> <a href="/tags/Spanner/" style="font-size: 13px;">Spanner</a> <a href="/tags/Spark/" style="font-size: 13px;">Spark</a> <a href="/tags/Stack/" style="font-size: 13px;">Stack</a> <a href="/tags/State-Compression/" style="font-size: 13.14px;">State Compression</a> <a href="/tags/String/" style="font-size: 13px;">String</a> <a href="/tags/Stringstream/" style="font-size: 13px;">Stringstream</a> <a href="/tags/Syscall/" style="font-size: 13px;">Syscall</a> <a href="/tags/Tricky/" style="font-size: 13.86px;">Tricky</a> <a href="/tags/Trie-Tree/" style="font-size: 13px;">Trie Tree</a> <a href="/tags/Two-Pointers/" style="font-size: 13.14px;">Two Pointers</a> <a href="/tags/Union-Find-Set/" style="font-size: 13px;">Union Find Set</a> <a href="/tags/ZooKeeper/" style="font-size: 13px;">ZooKeeper</a> <a href="/tags/xv6/" style="font-size: 13.29px;">xv6</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a><span class="archive-list-count">60</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Leetcode/">Leetcode</a>
              </p>
              <p class="item-title">
                <a href="/2021/08/25/479.%20Largest%20Palindrome%20Product/" class="title">479. Largest Palindrome Product</a>
              </p>
              <p class="item-date">
                <time datetime="2021-08-25T06:04:07.642Z" itemprop="datePublished">2021-08-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Leetcode/">Leetcode</a>
              </p>
              <p class="item-title">
                <a href="/2021/08/25/787.%20Cheapest%20Flights%20Within%20K%20Stops/" class="title">787. Cheapest Flights Within K Stops</a>
              </p>
              <p class="item-date">
                <time datetime="2021-08-25T06:04:07.640Z" itemprop="datePublished">2021-08-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Leetcode/">Leetcode</a>
              </p>
              <p class="item-title">
                <a href="/2021/08/25/790.%20Domino%20and%20Tromino%20Tiling/" class="title">790. Domino and Tromino Tiling</a>
              </p>
              <p class="item-date">
                <time datetime="2021-08-25T06:04:07.639Z" itemprop="datePublished">2021-08-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Leetcode/">Leetcode</a>
              </p>
              <p class="item-title">
                <a href="/2021/08/22/5852.%20Minimize%20the%20Difference%20Between%20Target%20and%20Chosen%20Elements/" class="title">5852. Minimize the Difference Between Target and Chosen Elements</a>
              </p>
              <p class="item-date">
                <time datetime="2021-08-22T15:36:07.532Z" itemprop="datePublished">2021-08-22</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Leetcode/">Leetcode</a>
              </p>
              <p class="item-title">
                <a href="/2021/08/22/5853.%20Find%20Array%20Given%20Subset%20Sums/" class="title">5853. Find Array Given Subset Sums</a>
              </p>
              <p class="item-date">
                <time datetime="2021-08-22T15:36:07.515Z" itemprop="datePublished">2021-08-22</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">Catalogue</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Conclusion</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.1.</span> <span class="toc-text"> Structural Design</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.2.</span> <span class="toc-text"> Specific Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.2.1.</span> <span class="toc-text"> Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.2.2.</span> <span class="toc-text">Concrete Plan</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">KVServer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">Raft</span></a></li></ol></li></ol></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-6.824-lab3-Conclusion" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      6.824 Conclusion
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/08/09/6.824-lab3-Conclusion/" class="article-date">
	  <time datetime="2021-08-09T08:53:11.992Z" itemprop="datePublished">2021-08-09</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/6-824/">6.824</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/KV-Raft/" rel="tag">KV Raft</a>, <a class="article-tag-link-link" href="/tags/Lab-Note/" rel="tag">Lab Note</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/08/09/6.824-lab3-Conclusion/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1>Conclusion</h1>

<p>Lab3 is a tough journey, especially when you finish the whole framework, then problem just starts. I took roughly two days to complete my draft and spent 2-3 times time to debug.</p>
<p>In order to remind me of this hard time, spending hours reading 20000 lines log, suspecting each line I wrote and make you who are reading this avoid bugs or debug smoothly, I will write problems as explicit as I can.</p>
<p>To make my design easy to understand, I will start with design graph.</p>
<h2> Structural Design</h2>

<p><img src="/2021/08/09/6.824-lab3-Conclusion/structural1.png" alt="structural1"></p>
<p><img src="/2021/08/09/6.824-lab3-Conclusion/structural2.jpg" alt="structural2"></p>
<h2> Specific Implementation</h2>

<h3> Overview</h3>

<p>Because detailed Raft design is described in former part, so let’s just assume we all pass Lab2 perfectly (Check it every time you modify Raft’s code!)</p>
<ul>
<li>For KV Server<ul>
<li>In 3A, we achieve the functions to send command and listen to channel till <em>Raft</em> peers reach agreement and persist the command, once <em>Server</em> receives specific message, it should execute the command(Without repetition).</li>
<li>In 3B, we will implement snapshot. This idea is straightforward but we need to overcome the side-effect it brings.</li>
</ul>
</li>
<li>For Raft<ul>
<li>We need not modify our Raft design in 3A</li>
<li>In 3B, we should modify our code to deal with what Snapshot brings<ul>
<li>the first problem is to make your <em>Raft</em> execute more fast to pass <strong>TestSnapshotSize3B</strong>. </li>
<li>What time to tell KVServer to snapshot</li>
<li>Index Convert</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Concrete Plan</h3>

<h4>KVServer</h4>

<ul>
<li><p>To avoid repeating execution, assign each clerk an unique ID and mark each command a monotonically increasing sequence number. So <em>Server</em> can exam this info. which stored in <em>map</em> to decide whether execute.</p>
</li>
<li><p>KVServer:: Get()  &amp; PutAppend()</p>
<p>A tricky implementation here is, in Get() we can achieve faster response by check the ClerkID’s current sequence number to get value directly.</p>
<p>You can do timeout check by <strong>Receive a event of timer.After</strong> or <strong>Condition variable of check a count value</strong></p>
</li>
<li><p>KVServer:: commitCommandHandler()</p>
<p>A thread function to listen to appMsg Channel. If receives message, it will do <strong>Valid check, Index check and Command check</strong> to execute a command in right way.</p>
<p><strong>Note:</strong> Because the channel is a FIFO sequence, <em>Server</em>‘s execution sequence is decided by Raft’s push sequence. It’s a nice point that we don’t need to pay extra attention keep <em>Raft</em> and <em>KVServer</em> in sync, especially when <em>Raft</em> requires for a Snapshot in a very index.</p>
</li>
<li><p>appMsg Channel with buffer</p>
<ul>
<li>To make execution more efficient and decouple <em>Raft</em> and <em>KVServer</em>. We can preallocate a buffer for this channel so <em>Raft</em>‘s log can be pipelined down into channel.</li>
<li>**Note:**Don’t worry about inconsistency, <em>Server</em> will still execute in sequence and <em>Raft</em> will still get the right index’s <em>Server’s</em> state Snapshot.</li>
</ul>
</li>
</ul>
<h4>Raft</h4>

<ul>
<li>Remember to check your <em>Raft</em> first when you encounter a problem!!!(90% bug)</li>
</ul>
<p>I actually don’t wanna talk a lot about basic design here, for <strong>InstallSnpshot RPC</strong> is much similar as previous design. But there are still some point I want to record.</p>
<ul>
<li><p>To achieve high concurrency.</p>
<ul>
<li>In previous part, I just make <strong>HeartBeat &amp; EntriesAppend</strong> a same mechanism to send : goroutine check rf.log every 100ms and send new log if nextIndex[i] &lt;= len(log) - 1.</li>
<li>Now we can add an extra send action in Start( )</li>
<li><strong>Note:</strong> Be careful when you do so. Imagine a partition situation: a network-failed leader gonna send his log to others each time it receives new log. Once it’s reconnected and receives info. from current leader and is ready to become follower, but  <strong>sendAppendEntries</strong> has been called. So a packet with up-to-dated term and false log will be received and accepted by other followers.<ul>
<li>The problem is caused by checkStatus() step and sendAppendEntries() are not atomic, and in low concurrency situation this failure somehow are less likely to happen. </li>
</ul>
</li>
</ul>
</li>
<li><p>Time point of chitchat</p>
<ul>
<li><em>Server</em> should send <em>maxRaftState</em> to <em>Raft</em> during init(), each time Raft do a commit, it should check RaftStateSize and send signal if oversize.</li>
<li>Each time <em>Raft</em> truncates log, <em>lastApplied</em> should be changed as well as <em>IastIncludedIndex</em></li>
<li><strong>Note:</strong> I read other’s Blog and they all mentioned one problem of deadlock which happens between Server and Raft. In my design, we don’t need to worry about it, for each layer is working just at its own range. If you design a structure that Locks kv.mu and rf.mu in same time, you should be aware of the bad consequence it may cause.</li>
</ul>
</li>
<li><p>A weird slice reference problem happened on me</p>
<ul>
<li><p>Problem description: Leader has a log : [A, B, C, D, E] for short, and in one moment, the AppendEntries log it send became : [C, D, C, D, E]. I checked locks and run hundreds of time of race detection with race-free. It costs nearly 1 day to locate and find reason.</p>
</li>
<li><p>If you aren’t interested in this problem, just keep in mind: Golang’s slice has a implicit mechanism of copy and truncate, each time you use <strong>newdata = data[start :  end]</strong>, you have the idea that newdata will be effected as long as data changed. The bug will sometimes even make no sense when you do more operation on newdata.</p>
</li>
<li><p>Now let me intro my bug:</p>
<p><img src="/2021/08/09/6.824-lab3-Conclusion/bug1.png" alt="image-20210706133342852"></p>
<p>​                                                            Think about what Test will print</p>
<ul>
<li><p>It seems slice are not allocate <em>b</em> a new space, so <em>b’s</em> pointer is point to data’s physical array[2], what makes thing worse is</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="number">0</span>] = data[<span class="number">4</span>]</span><br><span class="line">tmp := data[<span class="number">5</span> : ]</span><br><span class="line">data = data[:<span class="number">1</span>]</span><br><span class="line">data = <span class="built_in">append</span>(data, tmp...)</span><br></pre></td></tr></table></figure>

<p>also not assign a new memory to data. </p>
<p><img src="/2021/08/09/6.824-lab3-Conclusion/bug2.png" alt="image-20210706133933221"></p>
<p>​                                                                  So this is the result</p>
</li>
<li><p>But you can just use </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = data[<span class="number">4</span>:]</span><br></pre></td></tr></table></figure>

<p>to truncate your log, because it will allocate a new array to data.</p>
</li>
<li><p>Now let’s check my code</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Called by KVServer to set Snapshot*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">SetSnapshot</span><span class="params">(snapshot []<span class="keyword">byte</span>, index <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">	rf.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">	<span class="keyword">if</span> rf.lastIncludedIndex &gt;= index &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//rf.log[0] = rf.log[rf.logIndexToArrayIndex(index)]</span></span><br><span class="line">	<span class="comment">//tmp := rf.log[rf.logIndexToArrayIndex(index+1):]</span></span><br><span class="line">	<span class="comment">//rf.log = rf.log[:1]</span></span><br><span class="line">	<span class="comment">//rf.log = append(rf.log, tmp...)</span></span><br><span class="line">	rf.log = rf.log[rf.logIndexToArrayIndex(index) : ]</span><br><span class="line">	rf.lastIncludedIndex =  index</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		Be careful, the lastApplied need to be updated as well</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	rf.lastApplied = index</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">startAppendEntries</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//c := time.Now()</span></span><br><span class="line">	rf.mu.Lock()</span><br><span class="line">	<span class="keyword">if</span> rf.status != LEADER&#123;</span><br><span class="line">		rf.mu.Unlock()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	index := <span class="built_in">len</span>(rf.log) - <span class="number">1</span> + rf.lastIncludedIndex</span><br><span class="line">	term := rf.currentTerm</span><br><span class="line">	leaderid := rf.me</span><br><span class="line">	leaderCommit := rf.commitIndex</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line">		<span class="keyword">var</span> logs []Pair</span><br><span class="line">		<span class="keyword">var</span> prevLogIndex, prevLogTerm <span class="keyword">int</span></span><br><span class="line">		<span class="keyword">if</span> i == leaderid &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> rf.nextIndex[i] &lt;= rf.lastIncludedIndex&#123;</span><br><span class="line">			<span class="comment">//gonna send snapshot</span></span><br><span class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, lastIncludedIndex <span class="keyword">int</span>, lastIncludedTerm <span class="keyword">int</span>, data []<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">                <span class="comment">/* Install Snapshot RPC*/</span></span><br><span class="line">			...</span><br><span class="line">			&#125;(i, rf.lastIncludedIndex, rf.log[<span class="number">0</span>].Term, rf.persister.ReadSnapshot())</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> index &lt; rf.nextIndex[i] &#123;</span><br><span class="line">			prevLogIndex = index</span><br><span class="line">			prevLogTerm = rf.log[rf.logIndexToArrayIndex(prevLogIndex)].Term</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> index &gt;= rf.nextIndex[i] &#123;</span><br><span class="line">			logs = rf.log[rf.logIndexToArrayIndex(rf.nextIndex[i]) : rf.logIndexToArrayIndex(index+<span class="number">1</span>)]</span><br><span class="line">			prevLogIndex = rf.nextIndex[i] - <span class="number">1</span></span><br><span class="line">			prevLogTerm = rf.log[rf.logIndexToArrayIndex(prevLogIndex)].Term</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, prevTerm <span class="keyword">int</span>, prevIndex <span class="keyword">int</span>, logs []Pair)</span></span> &#123;</span><br><span class="line">			args := AppendEntriesArgs&#123;</span><br><span class="line">				Term:         term,</span><br><span class="line">				LeaderId:     leaderid,</span><br><span class="line">				PrevLogIndex: prevIndex,</span><br><span class="line">				PrevLogTerm:  prevTerm,</span><br><span class="line">				Entries:      logs,</span><br><span class="line">				LeaderCommit: leaderCommit,</span><br><span class="line">			&#125;</span><br><span class="line">			reply := AppendEntriesReply&#123;&#125;</span><br><span class="line">			ok := rf.sendAppendEntries(i, &amp;args, &amp;reply)</span><br><span class="line">			rf.mu.Lock()</span><br><span class="line">            ...</span><br><span class="line">			&#125;</span><br><span class="line">			rf.mu.Unlock()</span><br><span class="line">		&#125;(i, prevLogTerm, prevLogIndex, logs)</span><br><span class="line">	&#125;</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I just implicitly use the reference of log and pass it to the closure to call RPC. Although I lock the whole body of <em>startAppendEntries()</em>, the context within the closure is not atomic, so left log a time window to make change.</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>When you encounter with other bugs: DPrint is a good helper  to locate errors, and make sure every variable  goes on track.</p>
</li>
</ul>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/" title="6.824 Conclusion" target="_blank" rel="external">https://zjuytw.github.io/2021/08/09/6.824-lab3-Conclusion/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/ZjuYTW" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/ichigo1.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/ZjuYTW" target="_blank"><span class="text-dark">Yitao</span><small class="ml-1x">To become what I want to be!</small></a></h3>
        <div>A graduate student currently pursuing MS in Computer Science at Nantional University of Singapore. BSc at Zhejiang University.</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/08/09/6.824-lab4-Conclusion/" title="6.824 Lab4 Conclusion"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/08/09/6.824-Lab3/" title="6.824 Lab3 KVRaft"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="Catalogue" role="button">
        <span>[&nbsp;</span><span>Catalogue</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/ZjuYTW" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>